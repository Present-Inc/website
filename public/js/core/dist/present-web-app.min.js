/*! present-web-app 15-05-2014 */
var PresentWebApp=angular.module("PresentWebApp",["ngAnimate","ui.router","p.controllers","p.directives","p.services"]);PresentWebApp.config(["$stateProvider","$locationProvider",function(a,b){b.html5Mode(!0),a.state("home",{url:"/",templateUrl:"/views/home",controller:"homeCtrl",data:{navigation:!1,fullsreen:!0},resolve:{AppScreens:["HomeService",function(a){return a.preloadPhoneScreens()}],Transition:["Utilities",function(a){return a.transitionComplete(1e3)}]}}).state("discover",{url:"/discover",templateUrl:"/views/discover",controller:"discoverCtrl",data:{navigation:!0,fullsreen:!1},resolve:{Feed:["$stateParams","DiscoverService",function(a,b){return b.loadFeed()}],Transition:["Utilities",function(a){return a.transitionComplete(1200)}]}}).state("profile",{url:"/:user",templateUrl:"/views/profile",controller:"profileCtrl",data:{navigation:!0,fullsreen:!1},resolve:{Feed:["$stateParams","ProfileService",function(a,b){return console.log(a.user),b.loadFeed(a.user)}],Profile:["$stateParams","ProfileService",function(a,b){return b.loadProfile(a.user)}],Transition:["Utilities",function(a){return a.transitionComplete(1200)}]}}).state("present",{url:"/:user/p/:video",templateUrl:"/views/profile",controller:"individualPresentCtrl",data:{navigation:!0,fullsreen:!0},resolve:{Feed:["$stateParams","ProfileService",function(a,b){return b.loadIndividualPresent(a.video)}],Profile:["$stateParams","ProfileService",function(a,b){return b.loadProfile(a.user)}],Transition:["Utilities",function(a){return a.transitionComplete(800)}]}}).state("verification",{url:"/account/:user/confirm?email_confirmation_token",templateUrl:"/views/emailVerification",controller:"verificationCtrl",data:{navigation:!1,fullsreen:!0},resolve:{ConfirmMessage:["$stateParams","AccountService",function(a,b){return b.confirmEmail(a.user,a.email_confirmation_token)}]}}).state("resetPassword",{url:"/account/:user/reset_password?password_reset_token",templateUrl:"/views/resetPassword",controller:"resetPasswordCtrl",data:{navigation:!1,fullsreen:!0},resolve:{ValidParams:["$stateParams","Utilities",function(a,b){var c=[a.password_reset_token];return b.checkParams(c)}],Profile:["$stateParams","ProfileService",function(a,b){return b.loadProfile(null,a.user)}],Transition:["Utilities",function(a){return a.transitionComplete(600)}]}})}]),PresentWebApp.run(["$rootScope","$templateCache",function(a,b){a.$on("$viewContentLoaded",function(){b.removeAll()})}]);var pControllers=angular.module("p.controllers",["ngAnimate"]);pControllers.controller("mainCtrl",["$scope","$window","$location",function(a,b,c){a.message="Welcome to Present",a.app={isReady:!1,viewAnimation:"a-fade",style:{size:"fullscreen"},fullscreen:!0,navigation:!0,downloadModal:!1},a.$on("$stateChangeStart",function(){a.app.isReady=!1}),a.$on("$stateChangeSuccess",function(){a.app.isReady=!0,console.log(c.absUrl()),b._gaq.push(["_trackPageview",c.absUrl()])}),a.showModal=function(){a.app.downloadModal=!0}}]),pControllers.controller("downloadModalCtrl",["$scope","TextMessageService",function(a,b){a.phoneNumber="+1",a.feedbackMessage="Message and data rates may apply",a.sendDownloadLink=function(){console.log("Sending link..."),b.sendTextMessage(a.phoneNumber).then(function(){a.feedbackMessage="Success! The message has been sent."}).catch(function(){a.feedbackMessage=a.phoneNumber+" is not valid"})}}]),pControllers.controller("homeCtrl",["$scope","$interval","$timeout","AppScreens",function(a,b,c,d){a.images=d,a.app.fullscreen=!0,a.viewer={changing:!1,key:0,source:a.images[0]},b(function(){a.rotateScreens()},5e3),a.rotateScreens=function(){a.viewer.changing=!0,a.viewer.key==a.images.length-1?a.viewer.key=0:a.viewer.key++,c(function(){a.viewer.source=a.images[a.viewer.key],a.viewer.changing=!1},1e3)}}]),pControllers.controller("discoverCtrl",["$scope","$timeout","Feed","DiscoverService",function(a,b,c,d){a.app.fullscreen=!1,a.feedManager={active:null,presents:c.videos,cursor:c.cursor,isLoading:!1,needsRefreshed:!1,refreshLimit:15},console.log("Cursor: "+a.feedManager.cursor),a.loadMoreVideos=function(){a.feedManager.isLoading=!0,console.log("Loading more videos..."),d.loadFeed(a.feedManager.cursor).then(function(c){a.feedManager.cursor=c.cursor,console.log("Next Cursor: "+a.feedManager.cursor),b(function(){a.feedManager.presents=a.feedManager.presents.concat(c.videos),a.feedManager.presents.length==a.feedManager.refreshLimit?a.feedManager.needsRefreshed=!0:a.feedManager.isLoading=!1},2e3)})},a.refreshFeed=function(){a.feedManager.needsRefreshed=!1,a.feedManager.presents=[],a.loadMoreVideos()}}]),pControllers.controller("profileCtrl",["$scope","$timeout","Feed","Profile","ProfileService",function(a,b,c,d,e){a.app.fullscreen=!1,console.log("Profile Controllers"),a.user=d,a.alternateLayout={},a.user.fullName||(a.alternateLayout.user={"text-align":"center"},a.alternateLayout.profilePicture={"float":"none",margin:"0px auto 20px auto"}),a.feedManager={active:null,presents:c.videos,cursor:c.cursor,isLoading:!1,needsRefreshed:!1,refreshLimit:1},a.loadMoreVideos=function(){a.feedManager.isLoading=!0,console.log("Loading more videos..."),e.loadFeed(a.user.username,a.feedManager.cursor).then(function(c){a.mapProfileData(c.videos),a.feedManager.cursor=c.cursor,console.log("Next Cursor: "+a.feedManager.cursor),b(function(){a.feedManager.presents=c.videos,a.feedManager.isLoading=!1},2e3)})},a.refreshFeed=function(){a.feedManager.needsRefreshed=!1,a.feedManager.presents=[],a.loadMoreVideos()},a.mapProfileData=function(b){b.map(function(b){b.creator.profilePicture.url=a.user.profilePicture.url,b.creator.displayName=a.user.fullName?a.user.fullName:a.user.username,b.creator.username=a.user.username})},a.mapProfileData(a.feedManager.presents)}]),pControllers.controller("individualPresentCtrl",["$scope","Feed","Profile","ProfileService",function(a,b,c){a.app.fullscreen=!0,a.user=c,a.feedManager={active:null,presents:b.videos,cursor:null,isLoading:!1,needsRefreshed:!1,refreshLimit:1}}]),pControllers.controller("verificationCtrl",["$scope","ConfirmMessage",function(a,b){a.message=b}]),pControllers.controller("resetPasswordCtrl",["$scope","$stateParams","ValidParams","Profile","AccountService",function(a,b,c,d,e){a.app.fullscreen=!0,a.app.navigation=!1,console.log(d.username),a.validRequest=c,a.maxLength=128,a.minLength=5,a.error={message:"",type:""},a.userInput={username:d.username,password:"",confirmation:"",valid:!1},a.checkPassword=function(){a.userInput.password==a.userInput.confirmation?a.userInput.password.length<a.minLength?(a.error.message="Password must be at least 5 characters",a.error.type="short"):a.userInput.password.length>a.maxLength?(a.error.message="Password cannot be more than 120 characters",a.error.type="long"):""!=a.userInput.password&&(a.userInput.valid=!0,a.error.type="",a.error.message=""):(a.userInput.valid=!1,a.error.type="mismatch")},a.sendPassword=function(){"mismatch"==a.error.type&&(a.error.message="Passwords do not match"),a.userInput.valid&&(a.error.message="Working...",e.resetPassword(b.user,b.password_reset_token,a.userInput.password).then(function(b){a.error.message=b?"Your password has successfully been changed":"We could not reset your password. Please contact support@present.tv"}).catch(function(b){a.error.message=b}))}}]);var pDirectives=angular.module("p.directives",["ngAnimate","ui.router"]);pDirectives.directive("viewContainer",["$animate","$window","$location","$anchorScroll","$timeout",function(a,b,c,d){return{restrict:"EA",scope:!1,link:function(c,e){c.$on("$stateChangeSuccess",function(){a.addClass(e,"view-enter",function(){})}),c.$on("$stateChangeStart",function(d,f){c.app.navigation=f.data.navigation?!0:!1,c.app.fullscreen=f.data.fullscreen?!0:!1,a.addClass(e,"view-leave",function(){b.scrollTo(0,0)})}),angular.element(b).bind("scroll",function(){var a=b.innerWidth;c.app.fullscreen&&a>960&&d(null)}),e.bind("click",function(a){var b=angular.element(a.target),d=b.attr("class");c.app.downloadModal="downloadBtn"==d?!0:!1,c.$apply()})}}}]),pDirectives.directive("presentFeed",function(){return{restrict:"EA",controller:["$scope",function(a){console.log("Present Feed Initialized"),this.setActiveVideo=function(b){a.feedManager.active=b,a.$broadcast("activeVideoChanged",a.feedManager.active)}}]}}),pDirectives.directive("presentVideo",function(){return{restrict:"EA",templateUrl:"views/partials/presentVideo",replace:!0,controller:["$scope",function(a){a.livePlayer=a.present.isLive?"livePlayer":""}]}}),pDirectives.directive("jwplayer",function(){return{restrict:"EA",scope:{media:"=",islive:"=",videoid:"@"},require:"^presentFeed",template:'<img class="playerPlaceholder a-fade-fast" ng-src="{{media.still}}" ng-hide="video.playerLoaded"/><div></div>',controller:["$scope",function(a){a.activePlaylistUrl=a.isLive?a.media.live:a.media.replay,console.log(a.activePlaylistUrl),a.setupProperties={file:a.activePlaylistUrl,image:a.media.still,width:"100%",height:"100%",aspectratio:"1:1",skin:"five",autostart:"true",controls:"true",stretching:"exactfit",stagevideo:"false",hdButton:!1},a.video={_id:"present-"+a.videoid,state:"uninitialized",media:a.media,playing:!1}}],link:function(a,b,c,d){var e=b.children(),f=angular.element(e[1]);f.attr("id",a.video._id),a.checkState=function(){var b=angular.element(document.querySelector("#"+a.video._id));return b[0]?a.video.state:"destroyed"},f.waypoint(function(b){"down"==b&&(d.setActiveVideo(a.video),a.video.state=a.checkState(),"destroyed"!=a.video.state&&("uninitialized"==a.video.state?(a.video.state="loading",jwplayer(a.video._id).setup(a.setupProperties),jwplayer(a.video._id).onPlay(function(){"stopped"==a.video.state?jwplayer(a.video._id).play(!1):a.video.state="playing",a.video.playerLoaded=!0,a.$apply()}),jwplayer(a.video._id).onDisplayClick(function(){"playing"!=a.video.state&&(d.setActiveVideo(a.video),a.video.state="playing",jwplayer(a.video._id).play(!0))})):"stopped"==a.video.state&&(a.video.state="playing",jwplayer(a.video._id).play(!0))))},{offset:"80%"}),a.$on("activeVideoChanged",function(b,c){a.video.state=a.checkState(),c._id!=a.video._id&&"destroyed"!=a.video.state&&("playing"==a.video.state?(a.video.state="stopped",jwplayer(a.video._id).stop(),a.playerLoaded=!1,a.$apply()):"loading"==a.video.state&&(a.video.state="stopped",a.$apply()))})}}}),pDirectives.directive("password",[function(){return{restrict:"EA",link:function(a,b){angular.element(b);a.$watch("userInput.valid",function(){a.userInput.valid?a.matchStyle={border:"solid 1px #6CA361","background-color":"#CEF7A1"}:a.userInput.valid||(a.matchStyle={border:"solid 1px #ccc","background-color":"#fff"})})}}}]);var developmentServer="api.present.tv",protocol="https://",pServices=angular.module("p.services",[]);pServices.factory("VideosApiResource",["$http","$q",function(a,b){return{listBrandNewVideos:function(c){var d=protocol+developmentServer+"/v1/videos/list_brand_new_videos",e=b.defer();return a({method:"GET",url:d,params:{limit:"5",cursor:c?c:null}}).success(function(a){e.resolve(a)}).error(function(a,b){var c="ERROR in videosService: API returned with response code: "+b;e.reject(c)}),e.promise},listUserVideos:function(c,d){var e=protocol+developmentServer+"/v1/videos/list_user_videos",f=b.defer();return a({method:"GET",url:e,params:{limit:"5",username:c,cursor:d?d:null}}).success(function(a){f.resolve(a)}).error(function(a,b){var c="ERROR in videosService: API returned with response code: "+b;f.reject(c)}),f.promise},show:function(c){var d=protocol+developmentServer+"/v1/videos/show",e=b.defer();return a({method:"GET",url:d,params:{video_id:c}}).success(function(a){e.resolve(a)}).error(function(a,b){var c="ERROR in videosService: API returned with response code: "+b;e.reject(c)}),e.promise}}}]),pServices.factory("UsersApiResource",["$http","$q",function(a,b){return{show:function(c,d){var e=b.defer(),f=protocol+developmentServer+"/v1/users/show";return a({method:"GET",url:f,params:{username:c,user_id:d}}).success(function(a){e.resolve(a)}).error(function(a,b){var c="ERROR in usersService: API returned with a response code: "+b;e.reject(c)}),e.promise},confirmEmail:function(c,d){var e=b.defer(),f=protocol+developmentServer+"/v1/users/confirm_email";return a({method:"POST",url:f,data:{user_id:c,email_confirmation_token:d}}).success(function(a){e.resolve(a)}).error(function(a,b){var c="ERROR in usersService: API returned with a response code: "+b;e.reject(c)}),e.promise},resetPassword:function(c,d,e){var f=b.defer(),g=protocol+developmentServer+"/v1/users/reset_password";return a({method:"POST",url:g,data:{user_id:c,password_reset_token:d,password:e}}).success(function(a){f.resolve(a)}).error(function(a,b){f.reject(a)}),f.promise}}}]),pServices.factory("DiscoverService",["$q","VideosApiResource","FeedDelegate",function(a,b,c){return{loadFeed:function(d){var e=a.defer(),f={cursor:d?d:null,videos:[]};return b.listBrandNewVideos(d).then(function(a){return f.cursor=a.nextCursor,angular.forEach(a.results,function(a){var b=c.deserializeVideo(a.object);b.isAvailable&&f.videos.push(b)}),f}).then(function(a){c.preRenderFeed(a).then(function(){e.resolve(a)})}).catch(function(a){e.reject(a)}),e.promise}}}]),pServices.factory("ProfileService",["$q","VideosApiResource","UsersApiResource","FeedDelegate","ProfileDelegate",function(a,b,c,d,e){return{loadFeed:function(c,e){var f=a.defer(),g={cursor:"",videos:[]};return b.listUserVideos(c,e).then(function(a){return angular.forEach(a.results,function(b){g.cursor=a.nextCursor;var c=d.deserializeVideo(b.object);c.isAvailable&&g.videos.push(c)}),g}).then(function(a){d.preRenderFeed(a).then(function(){f.resolve(a)})}).catch(function(a){f.reject(a)}),f.promise},loadProfile:function(b,d){var f=a.defer(),g={};return c.show(b,d).then(function(a){g=e.deserializeProfile(a.result.object),f.resolve(g)}).catch(function(a){f.reject(a)}),f.promise},loadIndividualPresent:function(c){var e=a.defer(),f={cursor:"",videos:[]};return b.show(c).then(function(a){var b=d.deserializeVideo(a.result.object);f.videos.push(b),e.resolve(f)}),e.promise}}}]),pServices.factory("FeedDelegate",["$q","$interval",function(a,b){return{deserializeVideo:function(a){var b={};return b._id=a._id,b.title=a.title,b.isAvailable=a.isAvailable,b.mediaUrl={still:a.mediaUrls?a.mediaUrls.images["480px"]:"",live:a.mediaUrls?a.mediaUrls.playlists.live.master:"",replay:a.mediaUrls?a.mediaUrls.playlists.replay.master:""},b.creator={_id:a.creatorUser.object?a.creatorUser.object._id:"",username:a.creatorUser.object?a.creatorUser.object.username:"",fullName:a.creatorUser.object?a.creatorUser.object.profile.fullName:"",profilePicture:a.creatorUser.object?a.creatorUser.object.profile.picture:{}},b.likes=a.likes.count,b.start=a.creationTimeRange.startDate,b.end=a.creationTimeRange.endDate,a.creationTimeRange.endDate?(b.isLive=!1,b.timeAgo=moment(b.end).fromNow()):(b.isLive=!0,b.timeAgo="Present"),b.creator.displayName=b.creator.fullName?b.creator.fullName:b.creator.username,b},preRenderFeed:function(c){var d=[];return angular.forEach(c.videos,function(a){var c=new Image;c.src=a.mediaUrl.still;var e=b(function(){d.push(e),c.complete&&b.cancel(e)},100)}),a.all(d)}}}]),pServices.factory("ProfileDelegate",function(){return{deserializeProfile:function(a){var b={};return b._id=a._id,b.username=a.username,b.fullName=a.profile.fullName,b.profilePicture=a.profile.picture,b.description=a.profile.description,b.stats={videos:a.videos.count,views:a.views.count,demands:a.demands.count,followers:a.followers.count,friends:a.friends.count},b}}}),pServices.factory("HomeService",["$q",function(){return{preloadPhoneScreens:function(){var a=["assets/img/app-screen-2.png","assets/img/app-screen-1.png","assets/img/app-screen-3.png"];return angular.forEach(a,function(a){var b=new Image;b.src=a}),a}}}]),pServices.factory("TextMessageService",["$http","$q",function(a,b){return{sendTextMessage:function(c){var d=b.defer();return a({method:"POST",url:"/send_link/",data:{device:"iphone",number:c}}).success(function(){d.resolve()}).error(function(a,b){var c="ERROR in TextMessageService: API returned with a response code: "+b;console.log(c),d.reject()}),d.promise}}}]),pServices.factory("AccountService",["$q","UsersApiResource",function(a,b){return{confirmEmail:function(c,d){var e=a.defer();return b.confirmEmail(c,d).then(function(a){console.log(a),e.resolve("Thank you! Your account is now verified")}).catch(function(a){console.log(a),e.resolve("Incorrect Account Information.")}),e.promise},resetPassword:function(c,d,e){var f=a.defer();return b.resetPassword(c,d,e).then(function(){f.resolve(!0)}).catch(function(a){console.log(a.result),f.reject(a.result)}),f.promise}}}]),pServices.factory("Utilities",["$q","$timeout",function(a,b){return{transitionComplete:function(c){var d=a.defer();return b(function(){d.resolve()},c),d.promise},checkParams:function(b){var c=a.defer();return angular.forEach(b,function(a,d){a?d==b.length-1&&c.resolve(!0):c.resolve(!1)}),c.promise}}}]);