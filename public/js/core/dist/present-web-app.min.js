/*! present-web-app 25-04-2014 */
var PresentWebApp=angular.module("PresentWebApp",["ngAnimate","ui.router","p.controllers","p.directives","p.services"]);PresentWebApp.config(["$stateProvider","$locationProvider",function(a,b){b.html5Mode(!0),a.state("home",{url:"/",templateUrl:"/views/home",controller:"homeCtrl",resolve:{Images:["Utilities",function(a){var b=["http://10.61.32.61:8000/assets/img/left-frame-bg.jpg"];return a.preloadImages(b)}],Transition:["Utilities",function(a){return a.transitionComplete(1600)}]}}).state("download",{url:"/download",templateUrl:"/views/download",controller:"downloadCtrl",resolve:{Transition:["Utilities",function(a){return a.transitionComplete(1200)}]}}).state("discover",{url:"/discover",templateUrl:"/views/discover",controller:"discoverCtrl",resolve:{Feed:["DiscoverService",function(a){return a.loadFeed()}],Transition:["Utilities",function(a){return a.transitionComplete(1200)}]}}).state("profile",{url:"/:user",templateUrl:"/views/profile",controller:"profileCtrl",resolve:{Feed:["$stateParams","ProfileService",function(a,b){return console.log(a.user),b.loadFeed(a.user)}],Profile:["$stateParams","ProfileService",function(a,b){return b.loadProfile(a.user)}],Transition:["Utilities",function(a){return a.transitionComplete(1200)}]}}).state("present",{url:"/:user/p/:video",templateUrl:"/views/profile",controller:"individualPresentCtrl",resolve:{Feed:["$stateParams","ProfileService",function(a,b){return b.loadIndividualPresent(a.video)}],Profile:["$stateParams","ProfileService",function(a,b){return b.loadProfile(a.user)}],Transition:["Utilities",function(a){return a.transitionComplete(800)}]}}).state("verification",{url:"/account/:user/confirm?email_confirmation_token",templateUrl:"/views/emailVerification",controller:"verificationCtrl",resolve:{ConfirmMessage:["$stateParams","AccountService",function(a,b){return b.confirmEmail(a.user,a.email_confirmation_token)}]}}).state("resetPassword",{url:"/account/:user/reset_password?password_reset_token",templateUrl:"/views/resetPassword",controller:"resetPasswordCtrl",resolve:{ValidParams:["$stateParams","Utilities",function(a,b){var c=[a.password_reset_token];return b.checkParams(c)}]}})}]),PresentWebApp.run(["$rootScope","$templateCache",function(a,b){a.$on("$viewContentLoaded",function(){b.removeAll()})}]);var pControllers=angular.module("p.controllers",["ngAnimate"]);pControllers.controller("mainCtrl",["$scope",function(a){a.message="Welcome to Present",a.app={viewAnimation:"a-fade",isReady:!1},a.$on("$stateChangeStart",function(){a.app.isReady=!1}),a.$on("$stateChangeSuccess",function(){a.app.isReady=!0})}]),pControllers.controller("homeCtrl",["$scope",function(a){a.message="Discover the present",a.app.viewAnimation="a-fade"}]),pControllers.controller("discoverCtrl",["$scope","$timeout","Feed","DiscoverService",function(a,b,c,d){a.app.viewAnimation="a-fade",a.feedManager={active:null,presents:c.videos,cursor:c.cursor,isLoading:!1,needsRefreshed:!1,refreshLimit:15},console.log("Cursor: "+a.feedManager.cursor),a.loadMoreVideos=function(){a.feedManager.isLoading=!0,console.log("Loading more videos..."),d.loadFeed(a.feedManager.cursor).then(function(c){a.feedManager.cursor=c.cursor,console.log("Next Cursor: "+a.feedManager.cursor),b(function(){a.feedManager.presents=a.feedManager.presents.concat(c.videos),a.feedManager.presents.length==a.feedManager.refreshLimit?a.feedManager.needsRefreshed=!0:a.feedManager.isLoading=!1},2e3)})},a.refreshFeed=function(){a.feedManager.needsRefreshed=!1,a.feedManager.presents=[],a.loadMoreVideos()}}]),pControllers.controller("profileCtrl",["$scope","$timeout","Feed","Profile","ProfileService",function(a,b,c,d,e){a.app.viewAnimation="a-fade",console.log("Profile Controllers"),a.user=d,a.alternateLayout={},a.user.fullName||(a.alternateLayout.user={"text-align":"center"},a.alternateLayout.profilePicture={"float":"none",margin:"0px auto 20px auto"}),a.feedManager={active:null,presents:c.videos,cursor:c.cursor,isLoading:!1,needsRefreshed:!1,refreshLimit:1},a.feedManager.presents.map(function(b){b.creator.username=a.user.username}),a.loadMoreVideos=function(){a.feedManager.isLoading=!0,console.log("Loading more videos..."),e.loadFeed(a.user.username,a.feedManager.cursor).then(function(c){c.videos.map(function(b){b.creator.username=a.user.username}),a.feedManager.cursor=c.cursor,console.log("Next Cursor: "+a.feedManager.cursor),b(function(){a.feedManager.presents=c.videos,a.feedManager.isLoading=!1},2e3)})},a.refreshFeed=function(){a.feedManager.needsRefreshed=!1,a.feedManager.presents=[],a.loadMoreVideos()}}]),pControllers.controller("individualPresentCtrl",["$scope","Feed","Profile","ProfileService",function(a,b,c){a.app.viewAnimation="a-fade",a.user=c,a.feedManager={active:null,presents:b.videos,cursor:null,isLoading:!1,needsRefreshed:!1,refreshLimit:1}}]),pControllers.controller("downloadCtrl",[function(){}]),pControllers.controller("verificationCtrl",["$scope","ConfirmMessage",function(a,b){a.message=b}]),pControllers.controller("resetPasswordCtrl",["$scope","$stateParams","ValidParams","AccountService",function(a,b,c,d){a.validRequest=c,a.maxLength=128,a.minLength=3,a.error={message:"",type:""},a.userInput={password:"",confirmation:"",valid:!1},a.checkPassword=function(){a.userInput.password==a.userInput.confirmation?a.userInput.password.length<a.minLength?(a.error.message="Password must be at least 4 characters",a.error.type="short"):a.userInput.password.length>a.maxLength?(a.error.message="Password cannot be more than 120 characters",a.error.type="long"):""!=a.userInput.password&&(a.userInput.valid=!0,a.error.type="",a.error.message=""):(a.userInput.valid=!1,a.error.type="mismatch")},a.sendPassword=function(){console.log("resetting password"),"mismatch"==a.error.type&&(a.error.message="Passwords do not match"),a.userInput.valid&&(a.error.message="Working...",d.resetPassword(b.user,b.password_reset_token,a.userInput.password).then(function(b){a.error.message=b?"Your password has successfully been changed":"We could not reset your password. Please contact support@present.tv"}))}}]);var pDirectives=angular.module("p.directives",["ngAnimate"]);pDirectives.directive("viewContainer",["$animate","$window","$anchorScroll",function(a,b){return{restrict:"EA",scope:!1,link:function(c,d){c.$on("$stateChangeSuccess",function(){a.addClass(d,"dl-enter",function(){})}),c.$on("$stateChangeStart",function(){a.addClass(d,"dl-leave",function(){b.scrollTo(0,0)})})}}}]),pDirectives.directive("blockScroll",["$window","$anchorScroll","$state",function(a,b,c){return{restrict:"EA",link:function(){angular.element(a).bind("scroll",function(){"home"==c.current.name&&b()})}}}]),pDirectives.directive("banner",function(){return{restrict:"EA",templateUrl:"/views/partials/banner",replace:!0}}),pDirectives.directive("presentUser",function(){return{restrict:"EA",templateUrl:"views/partials/presentUser",replace:!0}}),pDirectives.directive("presentVideo",function(){return{restrict:"EA",templateUrl:"views/partials/presentVideo",replace:!0}}),pDirectives.directive("presentFeed",function(){return{restrict:"EA",controller:["$scope",function(a){console.log("Present Feed Initialized"),this.setActiveVideo=function(b){a.feedManager.active=b,a.$broadcast("activeVideoChanged",a.feedManager.active)}}]}}),pDirectives.directive("jwplayer",function(){return{restrict:"EA",scope:{media:"=",videoid:"@"},require:"^presentFeed",template:'<img class="playerPlaceholder a-fade" ng-src="{{media.still}}" ng-hide="video.playerLoaded"/><div></div>',controller:["$scope",function(a){a.setupProperties={file:a.media.replay,image:a.media.still,width:"100%",height:"100%",aspectratio:"1:1",skin:"five",autostart:"true",controls:"true",stretching:"exactfit",stagevideo:"false",hdButton:!1},a.video={_id:"present-"+a.videoid,state:"uninitialized",media:a.media,playing:!1}}],link:function(a,b,c,d){var e=b.children(),f=angular.element(e[1]);f.attr("id",a.video._id),a.checkState=function(){var b=angular.element(document.querySelector("#"+a.video._id));return b[0]?a.video.state:"destroyed"},f.waypoint(function(b){"down"==b&&(d.setActiveVideo(a.video),a.video.state=a.checkState(),"destroyed"!=a.video.state&&("uninitialized"==a.video.state?(a.video.state="loading",jwplayer(a.video._id).setup(a.setupProperties),jwplayer(a.video._id).onPlay(function(){"stopped"==a.video.state?jwplayer(a.video._id).play(!1):a.video.state="playing",a.video.playerLoaded=!0,a.$apply()}),jwplayer(a.video._id).onDisplayClick(function(){"playing"!=a.video.state&&(d.setActiveVideo(a.video),a.video.state="playing",jwplayer(a.video._id).play(!0))})):"stopped"==a.video.state&&(a.video.state="playing",jwplayer(a.video._id).play(!0))))},{offset:"50%"}),f.bind("click",function(){console.log("player element was clicked")}),a.$on("activeVideoChanged",function(b,c){a.video.state=a.checkState(),c._id!=a.video._id&&"destroyed"!=a.video.state&&("playing"==a.video.state?(a.video.state="stopped",jwplayer(a.video._id).stop(),a.playerLoaded=!1,a.$apply()):"loading"==a.video.state&&(a.video.state="stopped",a.$apply()))})}}}),pDirectives.directive("password",[function(){return{restrict:"EA",link:function(a,b){angular.element(b);a.$watch("userInput.valid",function(){a.userInput.valid?a.matchStyle={border:"solid 1px #6CA361","background-color":"#CEF7A1"}:a.userInput.valid||(a.matchStyle={border:"solid 1px #ccc","background-color":"#fff"})})}}}]);var developmentServer="api.present.tv",protocol="https://",pServices=angular.module("p.services",[]);pServices.factory("VideosApiResource",["$http","$q",function(a,b){return{listBrandNewVideos:function(c){var d=protocol+developmentServer+"/v1/videos/list_brand_new_videos",e=b.defer();return a({method:"GET",url:d,params:{limit:"5",cursor:c?c:null}}).success(function(a){e.resolve(a)}).error(function(a,b){var c="ERROR in videosService: API returned with response code: "+b;e.reject(c)}),e.promise},listUserVideos:function(c,d){var e=protocol+developmentServer+"/v1/videos/list_user_videos",f=b.defer();return a({method:"GET",url:e,params:{limit:"5",username:c,cursor:d?d:null}}).success(function(a){f.resolve(a)}).error(function(a,b){var c="ERROR in videosService: API returned with response code: "+b;f.reject(c)}),f.promise},show:function(c){var d=protocol+developmentServer+"/v1/videos/show",e=b.defer();return a({method:"GET",url:d,params:{video_id:c}}).success(function(a){e.resolve(a)}).error(function(a,b){var c="ERROR in videosService: API returned with response code: "+b;e.reject(c)}),e.promise}}}]),pServices.factory("CommentsApiResource",["$http","$q",function(a,b){return{listVideoComments:function(c){var d=protocol+developmentServer+"/v1/comments/list_video_comments",e=b.defer();return a({method:"GET",url:d,params:{video_id:c}}).success(function(a){e.resolve(a)}).error(function(a,b){var c="ERROR in commentsService: API returned with response code: "+b;e.reject(c)}),e.promise}}}]),pServices.factory("UsersApiResource",["$http","$q",function(a,b){return{show:function(c){var d=b.defer(),e=protocol+developmentServer+"/v1/users/show";return a({method:"GET",url:e,params:{username:c}}).success(function(a){d.resolve(a)}).error(function(a,b){var c="ERROR in usersService: API returned with a response code: "+b;d.reject(c)}),d.promise},confirmEmail:function(c,d){var e=b.defer(),f=protocol+developmentServer+"/v1/users/confirm_email";return a({method:"POST",url:f,data:{user_id:c,email_confirmation_token:d}}).success(function(a){e.resolve(a)}).error(function(a,b){var c="ERROR in usersService: API returned with a response code: "+b;e.reject(c)}),e.promise},resetPassword:function(c,d,e){console.log(c),console.log(d),console.log(e);var f=b.defer(),g=protocol+developmentServer+"/v1/users/reset_password";return a({method:"POST",url:g,data:{user_id:c,password_reset_token:d,password:e}}).success(function(a){f.resolve(a)}).error(function(a,b){var c="ERROR in usersService: API returned with a response code: "+b;f.reject(c)}),f.promise}}}]),pServices.factory("DiscoverService",["$q","VideosApiResource","FeedDelegate",function(a,b,c){return{loadFeed:function(d){var e=a.defer(),f={cursor:d?d:null,videos:[]};return b.listBrandNewVideos(d).then(function(a){f.cursor=a.nextCursor,angular.forEach(a.results,function(a){var b=c.deserializeVideo(a.object);f.videos.push(b)}),e.resolve(f)}).catch(function(a){e.reject(a)}),e.promise}}}]),pServices.factory("ProfileService",["$q","VideosApiResource","UsersApiResource","FeedDelegate","ProfileDelegate",function(a,b,c,d,e){return{loadFeed:function(c,e){var f=a.defer(),g={cursor:"",videos:[]};return b.listUserVideos(c,e).then(function(a){angular.forEach(a.results,function(b){g.cursor=a.nextCursor;var c=d.deserializeVideo(b.object);g.videos.push(c)}),f.resolve(g)}).catch(function(a){f.reject(a)}),f.promise},loadProfile:function(b){var d=a.defer(),f={};return c.show(b).then(function(a){f=e.deserializeProfile(a.result.object),d.resolve(f)}).catch(function(a){d.reject(a)}),d.promise},loadIndividualPresent:function(c){var e=a.defer(),f={cursor:"",videos:[]};return b.show(c).then(function(a){var b=d.deserializeVideo(a.result.object);f.videos.push(b),e.resolve(f)}),e.promise}}}]),pServices.factory("FeedDelegate",function(){return{deserializeVideo:function(a){var b={};return b._id=a._id,b.title=a.title,b.mediaUrl={still:a.mediaUrls?a.mediaUrls.images["480px"]:"",live:a.mediaUrls?a.mediaUrls.playlists.live.master:"",replay:a.mediaUrls?a.mediaUrls.playlists.replay.master:""},b.creator={_id:a.creatorUser.object?a.creatorUser.object._id:"",username:a.creatorUser.object?a.creatorUser.object.username:"",profilePicture:a.creatorUser.object?a.creatorUser.object.profile.picture:""},b.likes=a.likes.count,b.start=a.creationTimeRange.startDate,b.end=a.creationTimeRange.endDate,a.creationTimeRange.endDate?(b.isLive=!1,b.timeAgo=Math.abs(new Date-new Date(a.creationTimeRange.endDate))):(b.isLive=!0,b.timeAgo="Present"),b.comments="",b},deserializeComments:function(){return"comments"}}}),pServices.factory("ProfileDelegate",function(){return{deserializeProfile:function(a){var b={};return b._id=a._id,b.username=a.username,b.fullName=a.profile.fullName,b.profilePicture=a.profile.picture,b.description=a.profile.description,b.stats={videos:a.videos.count,views:a.views.count,demands:a.demands.count,followers:a.followers.count,friends:a.friends.count},b}}}),pServices.factory("AccountService",["$q","UsersApiResource",function(a,b){return{confirmEmail:function(c,d){var e=a.defer();return b.confirmEmail(c,d).then(function(a){console.log(a),e.resolve("Thank you! Your account is now verified")}).catch(function(a){console.log(a),e.resolve("Incorrect Account Information.")}),e.promise},resetPassword:function(c,d,e){var f=a.defer();return b.resetPassword(c,d,e).then(function(){f.resolve(!0)}).catch(function(){f.resolve(!1)}),f.promise}}}]),pServices.factory("Utilities",["$q","$timeout",function(a,b){return{transitionComplete:function(c){var d=a.defer();return b(function(){d.resolve()},c),d.promise},preloadImages:function(b){var c=a.defer();return console.log("preloading images"),angular.forEach(b,function(a){var b=new Image;b.src=a,c.resolve()}),c.promise},checkParams:function(b){var c=a.defer();return angular.forEach(b,function(a,d){a?d==b.length-1&&c.resolve(!0):c.resolve(!1)}),c.promise}}}]),pServices.factory("TeamInfo",["$q","$http",function(a,b){return{getTeam:function(){var c="/data/team.json",d=a.defer();return b({method:"GET",url:c}).success(function(a){d.resolve(a)}).error(function(){d.reject("Could't Load Data")}),d.promise}}}]);